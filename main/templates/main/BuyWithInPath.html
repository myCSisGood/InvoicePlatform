{% extends "Mainpage.html" %}
{% load static %}
{% block main %}
<div class="h-screen pt-10">
    <div class="container mx-auto py-4 h-full flex flex-col space-y-6 px-4">

        <!-- Main Grid Layout with adjusted spacing for sections -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow border-t-0">
            <!-- Left Section (Picture and Buttons) -->
            <div class="lg:col-span-2 p-5 rounded-lg shadow-lg bg-white relative h-full flex flex-col">
                <div class="flex items-center space-x-4">
                    <!-- Title with dynamic content -->
                    <span>{{ countyName }} {{ districtName }} {{ smallTag }} {% if path %} in {{ path }}{% endif %}</span>
                    
                    <!-- Buttons beside the title -->
                    <button id="showRegular" class="px-3 py-1 bg-green-500 text-white text-sm font-medium rounded-md hover:bg-green-600 transition duration-200">
                        Regular
                    </button>
                    <button id="showArticulation" class="px-3 py-1 bg-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-400 transition duration-200">
                        Articulation 
                    </button>
                    <button id="showCommunity" class="px-3 py-1 bg-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-400 transition duration-200">
                        Community
                    </button>
                    
                </div>
                
                <!-- Main content area with iframe -->
                <div class="flex justify-center mb-4 flex-grow overflow-auto">
                    <iframe id="picture" class="w-full h-full border-none rounded-md"></iframe>
                </div>
            
                <!-- Analyze and Save Buttons -->
                <div class="absolute bottom-4 right-4 flex space-x-3">
                    <button id="analyzeButton" class="px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg shadow hover:bg-red-600 transition duration-200">
                        Analyze
                    </button>
                    <button id="saveDataBtn" class="px-4 py-2 bg-green-500 text-white text-sm font-semibold rounded-lg shadow hover:bg-green-600 transition duration-200 flex items-center">
                        <ion-icon name="save-outline" class="mr-1"></ion-icon>Save
                    </button>
                    

                </div>
                <div id="messageBox" class="hidden px-3 py-2 rounded-md mt-4 max-w-xs mx-auto text-center text-sm"></div>

            </div>
            
            <!-- Right Section (Revise Form and Deeper Insight) -->
            <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                <!-- <div class="lg:col-span-2 p-5 rounded-lg shadow-lg bg-white relative h-full flex flex-col"> -->
                    <form method="GET" action="{% url 'main:getDeeperInsight' %}" class="flex flex-col space-y-4">
                        <div class="relative">
                            <label for="deeperInsightSearch" class="block text-lg font-medium text-gray-700">Deeper Insight</label>
                            <input type="text" id="deeperInsightSearch" placeholder="請選擇選項" class="mt-2 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" onfocus="toggleDropdown(true)" oninput="filterOptions()">
                            <input type="hidden" name="deeperInsightSearch" id="hiddenDeeperInsightSearch">
    
                            <!-- 下拉選單，初始狀態隱藏 -->
                            <div id="deeperInsightDropdown" class="absolute w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto">
                                <ul id="deeperInsightOptions">
                                    {% for option in options %}
                                        <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectOption('{{ option }}')">{{ option }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <button type="submit" class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 flex items-center text-sm w-24 ml-auto">
                            Go
                        </button>
                    </form>
                 <!-- Button to Show/Hide Title List -->
                {% if productList %}
      
            
                    <button id="viewTitleListButton" class="px-2 py-1 bg-blue-500 text-white text-sm font-medium rounded hover:bg-blue-600 transition duration-200">
                        Selected Products]itle List
                    </button>
            
                    <!-- Title List (Hidden by default) -->
                    <div id="titleListContainer" class="hidden mb-6">
                        {% for n in productList %}
                            <p class="text-sm ml-4">{{ forloop.counter }}. {{ n }}</p>
                        {% endfor %}
                    </div>
                    
                {% endif %}
                
                </div>
            </div>
            </div>
            
            <!-- Analysis Result Section - Spanning Both Columns -->
            <div id="analysisResult" class="lg:col-span-3 p-4 bg-blue-50 rounded-lg shadow-lg border border-blue-200 mt-4">
                <h3 class="text-lg font-semibold text-blue-800">Analysis Result:</h3>
                <p>Loading analysis...</p>
            </div>
        </div>
    </div>
</div>



<script>
    $(document).ready(function() {
        const buttons = document.querySelectorAll("#showRegular, #showArticulation, #showCommunity");
        function handleActiveButton(event) {
            buttons.forEach(button => {
                button.classList.remove("bg-green-500", "text-white");
                button.classList.add("bg-gray-300", "text-gray-700");
            });
            event.currentTarget.classList.add("bg-green-500", "text-white");
        }
        buttons.forEach(button => button.addEventListener("click", handleActiveButton));
        $('#saveDataBtn').click(function(e) {
            e.preventDefault(); // 防止預設的跳轉行為
            $.ajax({
                url: "{% url 'main:saveData' %}",
                type: "POST",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function(response) {
                    var messageBox = document.getElementById("messageBox");
                    messageBox.classList.remove("hidden");
                    messageBox.classList.add("bg-green-100", "text-green-700", "border", "border-green-300");
                    messageBox.innerHTML = `<p>${response.message}</p>`;

                    setTimeout(function() {
                        messageBox.classList.add("hidden");
                        messageBox.innerHTML = ""; 
                    }, 5000);
                },
                error: function(xhr) {
                    
                    var messageBox = document.getElementById("messageBox");
                    messageBox.classList.remove("hidden");
                    messageBox.classList.add("bg-red-100", "text-red-700", "border", "border-red-300");
                    messageBox.innerHTML = `<p>${xhr.responseJSON.message}</p>`;

                    setTimeout(function() {
                        messageBox.classList.add("hidden");
                        messageBox.innerHTML = "";
                    }, 5000);
                }

            });
        });
    });
    

    var analysisResult = ""; 
    var analysisType = "regular"; 
    var analysisInProgress = true;
    $(document).ready(function() {
        var nodes = "{{ nodes|escapejs }}";
        var edges = "{{ edges|escapejs }}";
        var analysisResult = ""; 
        var analysisInProgress = true; 

        function convertMarkdownToHTML(markdownText) {
        const htmlText = markdownText
            // 將標題轉換為不同級別的標題
            .replace(/^##### (.*$)/gim, '<li class="list-disc list-inside">$1</li>')   // 轉換五級標題為無序列表
            .replace(/^#### (.*$)/gim, '<h4 class="text-lg font-semibold text-blue-800 mb-2">$1</h4>') // 四級標題，帶有底部空間
            .replace(/^### (.*$)/gim, '<h3 class="text-xl font-bold text-blue-800 mb-3">$1</h3>')   // 三級標題，帶有更大的底部空間
            .replace(/^## (.*$)/gim, '<h2 class="text-2xl font-bold text-blue-900 mb-4">$1</h2>')    // 二級標題，
            .replace(/^# (.*$)/gim, '<h1 class="text-3xl font-extrabold text-blue-900 mb-6">$1</h1>')     // 一級標題，帶有更多的空間
            
            // 粗體和斜體處理
            .replace(/\*\*(.*)\*\*/gim, '<strong class="font-bold">$1</strong>') // 粗體字
            .replace(/\*(.*)\*/gim, '<em class="italic">$1</em>')     // 斜體字
            
            // 列點和段落處理
            .replace(/- (.*$)/gim, '<li class="list-disc list-inside">$1</li>')  // 無序列表項
            .replace(/\n\n/gim, '<br><br>')  // 將雙換行轉換為段落間距
            .replace(/\n/gim, '<br>');       // 單換行轉換為換行符
        return `<div class="prose max-w-none">${htmlText.trim()}</div>`;
        
    }



        function analyze() {
            $.ajax({
                url: "{% url 'main:analyze' %}",
                method: "POST",
                data: {
                    'analysisType': analysisType, 
                    'nodes': nodes,
                    'edges': edges,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                beforeSend: function() {
                    analysisInProgress = true;
                    $('#analysisResult').html("<h3 class='text-lg font-semibold text-blue-800'>Analysis Result:</h3><p>Loading...</p>"); 
                },
                success: function(response) {
                    if (response.analysis) {
                        analysisResult = response.analysis;
                        
                        var formattedResult = convertMarkdownToHTML(analysisResult);
                        $('#analysisResult').html(formattedResult);
                        $('#analysisResult').removeClass('hidden'); 
                    } else {
                        $('#analysisResult').removeClass('hidden');
                        $('#analysisResult').html("<p>No result available.</p>");
                    }
                    analysisInProgress = false; 
                    
                },
                error: function(xhr, status, error) {
                    $('#analysisResult').removeClass('hidden');
                    $('#analysisResult').html("<p>Error during analysis.</p>");
                    analysisInProgress = false;
                }
            });
        }

        analyze();
        $('#showRegular').click(function() {
            updateIframeContent(relationship);
            analysisType = 'regular'; 
            // analyze(); 
        });

        $('#showArticulation').click(function() {
            updateIframeContent(articulation);
            analysisType = 'articulation'; 
            // analyze(); 
        });

        $('#showCommunity').click(function() {
            updateIframeContent(communities);
            analysisType = 'community'; 
            // analyze(); 
        });
        // 當用戶點擊 "Analyze" 按鈕時顯示格式化的分析結果
        $('#analyzeButton').click(function() {
            if (analysisInProgress) {
                $('#analysisResult').removeClass('hidden');
                $('#analysisResult').html("<h3 class='text-lg font-semibold text-blue-800'>Analysis Result:</h3><p>Loading...</p>");
            } else {
                if (analysisResult) {
                    var formattedResult = convertMarkdownToHTML(analysisResult);
                    $('#analysisResult').removeClass('hidden');
                    $('#analysisResult').html(formattedResult);
                } else {
                    $('#analysisResult').removeClass('hidden');
                    $('#analysisResult').html("<p>No result available.</p>");
                }
            }
        });

        // 頁面加載時顯示初始圖像
        var relationship = `{% filter escapejs %}{{ relationship|safe }}{% endfilter %}`;
        var articulation = `{% filter escapejs %}{{ articulationPoint|safe }}{% endfilter %}`;
        var communities = `{% filter escapejs %}{{ communities|safe }}{% endfilter %}`;

        function updateIframeContent(content) {
            const frame = document.getElementById('picture');
            frame.contentDocument.open();
            frame.contentDocument.write(content);
            frame.contentDocument.close();
        }

        // 頁面加載時顯示 "Regular" 圖像
        updateIframeContent(relationship);

        
        
    });
    
    function toggleDropdown(show) {
        const dropdown = document.getElementById("deeperInsightDropdown");
        if (show) {
            dropdown.classList.remove("hidden");
        } else {
            setTimeout(() => dropdown.classList.add("hidden"), 300); // 延遲時間以允許選項點擊
        }
    }

    // 選擇選項並更新輸入框
    function selectOption(option) {
        document.getElementById("deeperInsightSearch").value = option;
        document.getElementById("hiddenDeeperInsightSearch").value = option;
        toggleDropdown(false);
    }

    // 篩選選項
    function filterOptions() {
        const searchValue = document.getElementById("deeperInsightSearch").value.toLowerCase();
        const options = document.getElementById("deeperInsightOptions").getElementsByTagName("li");

        let anyVisible = false; // 用來追蹤是否有顯示的選項

        for (let i = 0; i < options.length; i++) {
            const optionText = options[i].textContent.toLowerCase();
            if (optionText.includes(searchValue)) {
                options[i].style.display = "block";
                anyVisible = true;
            } else {
                options[i].style.display = "none";
            }
        }

        // 若有任何符合搜尋條件的選項，則顯示下拉選單
        if (searchValue === "" || anyVisible) {
            toggleDropdown(true);
        } else {
            toggleDropdown(false);
        }
    }

    // 點擊輸入框顯示下拉選單
    document.getElementById("deeperInsightSearch").addEventListener("focus", function() {
        toggleDropdown(true);
    });

    // 點擊範圍外隱藏下拉選單
    document.addEventListener("click", function(event) {
        const searchInput = document.getElementById("deeperInsightSearch");
        const dropdown = document.getElementById("deeperInsightDropdown");

        if (!dropdown.contains(event.target) && event.target !== searchInput) {
            toggleDropdown(false);
        }
    });
    document.getElementById('viewTitleListButton').addEventListener('click', function() {
        const titleListContainer = document.getElementById('titleListContainer');
        titleListContainer.classList.toggle('hidden');
    });
</script>

<style>
</style>
{% endblock %}