{% extends "Mainpage.html" %}

{% block main %}
<body class="bg-gray-100 h-screen flex flex-col">
    <div class="container mx-auto py-6 flex-grow flex flex-col">

        <!-- Header with Info Button -->
        <div class="flex items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-900 mr-2">Show with {{displayType}}</h2>
            <button id="infoButton" class="ml-2 p-2 rounded-full text-purple-600 hover:text-purple-800 bg-white shadow-md hover:bg-gray-100 transition">
                <ion-icon name="help-circle-outline" size="large"></ion-icon>
            </button>
        </div>

        <!-- Info Modal -->
        <div id="infoModal" class="fixed z-50 inset-0 hidden overflow-y-auto">
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                    <div class="absolute inset-0 bg-gray-800 opacity-50"></div>
                </div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div class="inline-block align-bottom bg-white rounded-lg px-6 pt-5 pb-4 text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                    <div class="absolute top-0 right-0 pt-4 pr-4">
                        <button id="closeModal" class="bg-white rounded-md text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                            <span class="sr-only">Close</span>
                            <ion-icon name="close-outline" size="large"></ion-icon>
                        </button>
                    </div>
                    <div id="infoContent" class="mt-3 text-center sm:mt-5">
                        Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow overflow-hidden">
            
        <!-- Picture Section -->
        <div class="lg:col-span-2 p-6 rounded-lg shadow-xl border border-gray-300 bg-white relative flex flex-col">
            <div class="flex justify-center mt-4 mb-4 flex-grow overflow-auto">
                <iframe id="picture" class="w-full h-128 border-none rounded-lg shadow-inner"></iframe>
            </div>

            <!-- Overtime and Save Buttons (Top-Right) -->
            <div class="absolute bottom-4 right-4 flex space-x-2">
                <a href="{% url 'main:displayOvertime' %}" class="px-4 py-4 bg-gray-700 text-white rounded-lg hover:bg-gray-500 flex items-center text-base transition">
                    Overtime
                </a>
                <button type="button" onclick="saveData()" class="px-4 py-4 bg-purple-700 text-white rounded-lg hover:bg-purple-500 flex items-center text-base transition">
                    <ion-icon name="save-outline" class="mr-1"></ion-icon>Save
                </button>
            </div>

            <!-- Show Buttons (Bottom-Left, Vertical) -->
            <div class="flex flex-col space-y-2 absolute bottom-12 left-6">
                <button id="showRegular" class="px-6 py-4 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 flex items-center text-base transition">
                    Show with Regular
                </button>
                <button id="showArticulation" class="px-6 py-4 bg-green-500 text-white rounded-lg hover:bg-green-400 flex items-center text-base transition">
                    Show with Articulation Points
                </button>
                <button id="showCommunity" class="px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-500 flex items-center text-base transition">
                    Show with Community
                </button>
            </div>
        </div>



            <!-- Form and Insight Form Sections -->
            <div class="flex flex-col space-y-6 h-full overflow-auto">
                <!-- Main Form -->
                <form method="POST" class="bg-white p-6 rounded-lg shadow-lg flex flex-col space-y-6">
                    {% csrf_token %}
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">Revise</h3>
                    <div>
                        <label for="limit" class="block text-lg font-medium text-gray-800">Limit (1-300)</label>
                        <input type="number" id="limit" name="limit" min="1" max="300" class="mt-2 block w-full py-3 px-4 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 sm:text-lg" placeholder="輸入限制數字">
                    </div>
                    <div>
                        <label for="district" class="block text-lg font-medium text-gray-800">行政區</label>
                        <select id="district" name="district" class="mt-2 block w-full py-3 px-4 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 sm:text-lg">
                            <option value="">請選擇行政區</option>
                            {% for district in districtList %}
                                <option value="{{ district }}">{{ district }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="store" class="block text-lg font-medium text-gray-800">通路</label>
                        <select id="store" name="store" class="mt-2 block w-full py-3 px-4 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 sm:text-lg">
                            <option value="" selected></option>
                            {% for store in stores %}
                                <option value="{{ store }}">{{ store }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="startTime" class="block text-lg font-medium text-gray-800">開始時間</label>
                        <input type="text" id="startTime" name="startTime" value="{{ startTime }}" class="datetimepicker mt-2 block w-full py-3 px-4 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 sm:text-lg">
                    </div>
                    <div>
                        <label for="endTime" class="block text-lg font-medium text-gray-800">結束時間</label>
                        <input type="text" id="endTime" name="endTime" value="{{ endTime }}" class="datetimepicker mt-2 block w-full py-3 px-4 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 sm:text-lg">
                    </div>
                    <div class="flex justify-between">
                        <a href="{% url 'main:drawBuyWith' %}?select_area" class="px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 flex items-center text-base transition">
                            Draw Another Picture
                        </a>
                        <button type="submit" class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-500 flex items-center text-base transition">
                            Submit
                        </button>
                    </div>
                </form>

                <!-- Insight Form -->
                <form method="GET" action="{% url 'main:getDeeperInsight' %}" class="bg-white p-6 rounded-lg shadow-lg flex flex-col space-y-4">
                    <div>
                        <label for="newOption" class="block text-xl font-medium text-gray-800">Choose one to see deeper</label>
                        <select id="newOption" name="option" class="mt-2 block w-full py-3 px-4 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 sm:text-lg">
                            <option value="">Deeper Insight</option>
                            {% for option in options %}
                                <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="px-3 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center text-base transition w-24 ml-auto">
                        Go
                    </button>
                </form>
            </div>
        </div>

    </div>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            flatpickr("#startTime", {
                locale: "zh_tw",
                plugins: [new monthSelectPlugin({
                    shorthand: true,
                    dateFormat: "Y-m",
                    altFormat: "F Y",
                })],
            });

            flatpickr("#endTime", {
                locale: "zh_tw",
                plugins: [new monthSelectPlugin({
                    shorthand: true,
                    dateFormat: "Y-m",
                    altFormat: "F Y",
                })],
            });


            $('#infoButton').click(function() {
                var displayType = "{{ displayType }}";
                $.ajax({
                    url: "{% url 'main:showInfo' %}",
                    data: {
                        'displayType': displayType
                    },
                    success: function(data) {
                        $('#infoContent').html(data.content);
                        $('#infoModal').removeClass('hidden');
                    }
                });
            });

            $('#closeModal').click(function() {
                $('#infoModal').addClass('hidden');
            });

            var relationship = `{% filter escapejs %}{{ relationship|safe }}{% endfilter %}`;
            var articulation = `{% filter escapejs %}{{ articulationPoint|safe }}{% endfilter %}`;
            var communities = `{% filter escapejs %}{{ communities|safe }}{% endfilter %}`;

            updateIframeContent(relationship);
            
            $('#showRegular').click(function() {
                updateIframeContent(relationship);
            });

            $('#showArticulation').click(function() {
                updateIframeContent(articulation);
            });

            $('#showCommunity').click(function() {
                updateIframeContent(communities);
            });

            function updateIframeContent(content) {
                const frame = document.getElementById('picture');
                frame.contentDocument.open();
                frame.contentDocument.write(content);
                frame.contentDocument.close();
            }
        });
    </script>
</body>
{% endblock %}
