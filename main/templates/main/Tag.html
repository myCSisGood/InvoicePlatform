{% extends "Mainpage.html" %}

{% block main %}
  <div class="flex justify-center mt-0">
    <!-- 調整卡片的 aspect-ratio 和寬度 -->
    <div class="bg-gradient-to-b from-gray-100 to-gray-200 p-8 rounded-lg shadow-lg relative flex flex-col items-center" style="aspect-ratio: 3 / 4; width: 90vw; max-width: 500px;">
      <div class="flex flex-col items-center w-full">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">請選擇分類和產品</h2>
        {% if pictureType == 1 %}
        <form id="tagForm" method="POST" action="{% url 'main:drawBuyWith' %}?step=select_tag">
        {% elif pictureType == 2 %}
        <form id="tagForm" method="POST" action="{% url 'main:drawPath' %}?step=select_tag">
        {% elif pictureType == 4 %}
        <form id="tagForm" method="POST" action="{% url 'main:drawRFMwithProduct' %}?step=select_tag">
        {% endif %}
          {% csrf_token %}
          
          <!-- 隱藏的 input 來存儲最終選中的 product list -->
          <input type="hidden" id="selectedProductsInput" name="selectedProducts" value="">

          <div class="mb-6 w-full">
            <label for="bigTag" class="block text-lg font-medium text-gray-700 mb-2 text-center">選擇分類</label>
            <input type="text" id="tagFilter" class="block w-full py-3 px-4 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-lg mb-2" placeholder="搜尋標籤...">
            <select id="bigTag" name="bigTag" class="block w-full py-3 px-4 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-lg">
              <option value="">請選擇分類</option>
              {% for tag in bigTags %}
                <option value="{{ tag }}">{{ tag }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-6 w-full">
            <label for="smallTag" class="block text-lg font-medium text-gray-700 mb-2 text-center">選擇子分類</label>
            <input type="text" id="itemFilter" class="block w-full py-3 px-4 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-lg mb-2" placeholder="搜尋項目...">
            <select id="smallTag" name="smallTag" class="block w-full py-3 px-4 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-lg">
              <option value="">請先選擇分類</option>
            </select>
          </div>

          <div class="mb-6 w-full">
            <label for="productFilter" class="block text-lg font-medium text-gray-700 mb-2 text-center">搜尋產品</label>
            <input type="text" id="productFilter" class="block w-full py-3 px-4 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-lg mb-2" placeholder="搜尋產品...">
            
            <!-- 顯示篩選結果 -->
            <ul id="productResults" class="bg-white border border-gray-300 mt-2 max-h-48 overflow-auto"></ul>
          </div>

          <!-- 已選產品 -->
          <div class="mb-6 w-full">
            <label class="block text-lg font-medium text-gray-700 mb-2 text-center">已選擇的產品</label>
            <ul id="selectedProducts" class="list-disc pl-5"></ul>
            <div id="totalProductCount" class="mt-4 text-lg font-semibold">總資料數量: 0</div>
          </div>

          <!-- 顯示錯誤訊息的區域 -->
          <div id="errorMessage" class="text-red-500 text-sm mb-4 text-center" style="display: none;"></div>

          <div class="flex justify-between w-full">
            <button type="button" onclick="window.history.back()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 flex items-center text-base">
              <ion-icon name="arrow-back-outline" class="mr-2"></ion-icon>Back
            </button>
            <button type="submit" id="submitBtn" class="px-6 py-3 bg-indigo-700 text-white rounded-lg flex items-center text-base">
              <ion-icon name="save-outline" class="mr-2"></ion-icon>Save
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function() {
      var selectedProducts = [];
      var totalProductCount = 0;

      // 當大類選擇發生變更時，自動獲取對應的小類
      $('#bigTag').change(function() {
        var bigtag = $(this).val();
        $.ajax({
          url: '{% url "main:getSmallTags" %}',
          data: { 'bigtag': bigtag },
          success: function(data) {
            var smallTagSelect = $('#smallTag');
            smallTagSelect.empty();
            smallTagSelect.append('<option value="">請選擇子分類</option>');
            $.each(data.smallTags, function(index, value) {
              smallTagSelect.append('<option value="' + value.name + '">' + value.name + '</option>');
            });
            smallTagSelect.val('{{ smallTag }}'); 
          }
        });
      });

      // 搜索產品時，顯示篩選結果
      $('#productFilter').on('input', function() {
        var filterValue = $(this).val().toLowerCase();
        var smallTag = $('#smallTag').val();
        if (!smallTag) {
          $('#productResults').empty();
          return;
        }

        $.ajax({
          url: '{% url "main:getProducts" %}',
          data: { 'smallTag': smallTag },
          success: function(data) {
            var filteredProducts = data.products.filter(function(product) {
              return product.name.toLowerCase().indexOf(filterValue) > -1;
            });

            $('#productResults').empty();
            filteredProducts.forEach(function(product) {
              $('#productResults').append(`
                <li class="p-2">
                  <input type="checkbox" class="productCheckbox" data-product="${product.name}" data-count="${product.count}">
                  ${product.name} (${product.count} 筆)
                </li>
              `);
            });

            $('.productCheckbox').on('change', function() {
              var product = $(this).data('product');
              var count = $(this).data('count');
              if (this.checked) {
                if (!selectedProducts.includes(product)) {
                  selectedProducts.push(product);
                  $('#selectedProducts').append('<li>' + product + ' (' + count + ' 筆)</li>');
                  totalProductCount += count;
                }
              } else {
                selectedProducts = selectedProducts.filter(function(p) { return p !== product });
                $('#selectedProducts li:contains("' + product + '")').remove();
                totalProductCount -= count;
              }

              $('#totalProductCount').text('總資料數量: ' + totalProductCount);
              $('#selectedProductsInput').val(selectedProducts.join(','));
            });
          }
        });
      });

      $('#tagForm').submit(function(event) {
        if (totalProductCount < 100) {
          event.preventDefault();
          $('#errorMessage').text('總資料數量必須大於或等於 100 才能提交').show();
        } else {
          $('#errorMessage').hide();
        }
      });

      var selectedBigTag = "{{ bigTag }}";
      if (selectedBigTag) {
        $('#bigTag').val(selectedBigTag).change();
      }
    });
  </script>
{% endblock %}

